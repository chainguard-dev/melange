name: Configure GCP Maven Central mirror for faster downloads
needs:
  packages:
    - busybox
pipeline:
  - runs: |
      # Point Maven's default local repository to the melange cache so
      # downloaded dependencies can be reused across builds.  Uses a symlink
      # instead of settings.xml <localRepository> so that builds which
      # hardcode ~/.m2/repository paths keep working.
      # Symlink both /root/.m2/repository (used by qemu runner where the
      # build user is root) and $HOME/.m2/repository (used by bubblewrap/
      # docker where HOME=/home/build).
      if [ -d "/var/cache/melange" ]; then
        mkdir -p /var/cache/melange/m2repository
        for m2dir in /root/.m2 "$HOME/.m2"; do
          mkdir -p "$m2dir"
          if [ ! -e "$m2dir/repository" ]; then
            ln -s /var/cache/melange/m2repository "$m2dir/repository"
          fi
        done
      fi

      # Maven checks $USER/.m2, we set $HOME to /home/build but it hardcodes $USER somehow
      mkdir -p /root/.m2
      cat > /root/.m2/settings.xml <<EOF
        <settings>
          <mirrors>
            <mirror>
              <id>google-maven-central</id>
              <name>GCS Maven Central mirror</name>
              <url>https://maven-central.storage-download.googleapis.com/maven2/</url>
              <mirrorOf>*</mirrorOf>
            </mirror>
          </mirrors>
        </settings>
      EOF
