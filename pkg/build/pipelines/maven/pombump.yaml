name: Run pombump tool to update versions and properties in a Maven POM file
needs:
  packages:
    - busybox
    - pombump

inputs:
  patch-file:
    description: |
      Patches file to use for updating the POM file
    default: ./pombump-deps.yaml
  properties-file:
    description: |
      Properties file to be used for updating the POM file
    default: ./pombump-properties.yaml
  dependencies:
    description: |
      Dependencies to be used for updating the POM file via command line flag
  properties:
    description: |
      Properties to update / add the POM file via command line flag
  pom:
    description: |
      Path to pom.xml
    default: pom.xml
  debug:
    description: |
      Enable debug mode, which will print out the diffs of the pom.xml file after running pombump
    default: false
  show-dependency-tree:
    default: false
    description: Display a dependency tree for the existing pom.xml file

pipeline:
  - runs: |
      # Point Maven's default local repository to the melange cache so
      # downloaded dependencies can be reused across builds.  Uses a symlink
      # instead of settings.xml <localRepository> so that builds which
      # hardcode ~/.m2/repository paths (e.g. Cassandra's build-resolver.xml)
      # keep working.
      # Symlink both /root/.m2/repository (used by qemu runner where the
      # build user is root) and $HOME/.m2/repository (used by bubblewrap/
      # docker where HOME=/home/build).
      if [ -d "/var/cache/melange" ]; then
        mkdir -p /var/cache/melange/m2repository
        for m2dir in /root/.m2 "$HOME/.m2"; do
          mkdir -p "$m2dir"
          if [ ! -e "$m2dir/repository" ]; then
            ln -s /var/cache/melange/m2repository "$m2dir/repository"
          fi
        done
      fi

      PATCH_FILE_FLAG=""
      PROPERTIES_FILE_FLAG=""
      DEPENDENCIES_FLAG=""
      PROPERTIES_FLAG=""

      if [ -f "${{inputs.patch-file}}" ]; then
        PATCH_FILE_FLAG="--patch-file ${{inputs.patch-file}}"
      fi

      if [ -f "${{inputs.properties-file}}" ]; then
        PROPERTIES_FILE_FLAG="--properties-file ${{inputs.properties-file}}"
      fi

      if [ -n "${{inputs.dependencies}}" ]; then
        DEPENDENCIES_FLAG="--dependencies ${{inputs.dependencies}}"
      fi

      if [ -n "${{inputs.properties}}" ]; then
        PROPERTIES_FLAG="--properties ${{inputs.properties}}"
      fi
      
      if [ "${{inputs.show-dependency-tree}}" = "true" ]; then
        mvn dependency:tree
      fi

      pombump ${{inputs.pom}} $PATCH_FILE_FLAG $PROPERTIES_FILE_FLAG $DEPENDENCIES_FLAG $PROPERTIES_FLAG > "${{inputs.pom}}.new"

      if [ "${{inputs.debug}}" = "true" ]; then
        # If there are any differences, it will return a non-zero exit code, so we use `|| true` to ignore that
        diff -w "${{inputs.pom}}" "${{inputs.pom}}.new" || true
      fi

      mv "${{inputs.pom}}.new" ${{inputs.pom}} 