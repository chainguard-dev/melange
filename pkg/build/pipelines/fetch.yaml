name: Fetch and extract external object into workspace

needs:
  packages:
    - wget

inputs:
  strip-components:
    description: |
      The number of path components to strip while extracting.
    default: 1

  directory:
    description: |
      The directory to extract the artifact into (passed to `tar -C`)
    default: .

  extract:
    description: |
      Whether to extract the downloaded artifact as a source tarball.
    default: true

  expected-sha256:
    description: |
      The expected SHA256 of the downloaded artifact.

  expected-sha512:
    description: |
      The expected SHA512 of the downloaded artifact.

  expected-none:
    description: |
      There is no expected checksum.

  purl-name:
    description: |
      package-URL (PURL) name for use in SPDX SBOM External References
    default: ${{package.name}}

  purl-version:
    description: |
      package-URL (PURL) version for use in SPDX SBOM External References
    default: ${{package.version}}

  uri:
    description: |
      The URI to fetch as an artifact.
    required: true

  timeout:
    description: |
      The timeout (in seconds) to use for connecting and reading.
      The fetch will fail if the timeout is hit.
    default: 5

  dns-timeout:
    description: |
      The timeout (in seconds) to use for DNS lookups.
      The fetch will fail if the timeout is hit.
    default: 20

  retry-limit:
    description: |
      The number of times to retry fetching before failing.
    default: 5

  delete:
    description: |
      Whether to delete the fetched artifact after unpacking.
    default: false

pipeline:
  - runs: |
      CACHEDIR="/var/cache/melange"

      if [ -n "${{inputs.expected-sha512}}" ]; then
        hashsize=512
        expected="${{inputs.expected-sha512}}"
      elif [ -n "${{inputs.expected-sha256}}" ]; then
        hashsize=256
        expected="${{inputs.expected-sha256}}"
      elif [ -z "${{inputs.expected-none}}" ]; then
        printf "One of expected-sha256 or expected-sha512 is required"
        exit 1
      else
        hashsize=""
      fi

      bn="$(basename "${{inputs.uri}}")"

      fn=""
      if [ -n "$hashsize" ]; then
        fn="${CACHEDIR}/sha${hashsize}:${expected}"
        if [ -f "$fn" ]; then
          printf "fetch: found ${fn} in cache\n"
          cp "${fn}" "${bn}"
        fi
      fi

      if [ ! -f "${bn}" ]; then
        wget '-T${{inputs.timeout}}' '--dns-timeout=${{inputs.dns-timeout}}' '--tries=${{inputs.retry-limit}}' --random-wait --retry-connrefused --continue '${{inputs.uri}}'
      fi

      if [ -n "$hashsize" ]; then
        printf "fetch: Expected sha${hashsize}: ${expected}\n"
        sum="$(sha${hashsize}sum "${bn}" | awk '{print $1}')"
        if [ "${expected}" != "${sum}" ]; then
          printf "fetch: Expected sha${hashsize} does not match found: ${sum}\n"
          exit 1
        fi
        if [ -d "${CACHEDIR}" ]; then
          printf "fetch: Caching ${bn} in ${fn}\n"
          cp "${bn}" "${fn}" || { rm -f "${fn}"; printf "fetch: Caching failed\n"; }
        else
          printf "fetch: ${CACHEDIR} not available, will not cache ${bn}\n"
        fi
      else
        printf "fetch: Checksum validation skipped\n"
      fi

      if [ "${{inputs.extract}}" = "true" ]; then
        tar -x '--strip-components=${{inputs.strip-components}}' --no-same-owner -C '${{inputs.directory}}' -f "${bn}"
      fi

      if [ "${{inputs.delete}}" = "true" ]; then
        rm "${bn}"
      fi
