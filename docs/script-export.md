# Melange Script Export

Melange's script export feature allows you to save all pipeline steps as individual executable scripts for debugging, analysis, and manual execution. This feature is especially useful for troubleshooting build issues and understanding complex pipeline flows.

## Overview

When you use the `--save-scripts` flag with `melange build`, `melange compile`, or `melange test`, all pipeline steps are saved as executable shell scripts in `/home/build/.melange-scripts/` within the build environment.

## Basic Usage

```bash
# Export scripts during build
melange build --save-scripts package.yaml

# Export scripts during compilation
melange compile --save-scripts --arch=aarch64

# Export scripts during testing
melange test --save-scripts package.yaml
```

## Exported Script Structure

The script export feature creates the following files:

```
/home/build/.melange-scripts/
├── step-01-basic.sh              # Individual pipeline steps
├── step-02-configure.sh
├── create-test-file.sh           # Steps from 'uses:' pipelines
├── prepare-input.sh              # Steps from external pipelines
├── run-all.sh                    # Executes all scripts in order
└── environment.sh                # Sets up build environment
```

### Individual Scripts

Each pipeline step becomes an executable script that:

- Sets up the correct working directory
- Preserves environment variables
- Can be run from any directory
- Includes helpful headers and documentation

Example exported script:
```bash
#!/bin/sh
# Generated by Melange - Pipeline Script
# Step: step-01-basic
# Working Directory: /home/build
#
# This script can be run from any directory and will set up the proper
# build environment and working directory automatically.

set -e

# Ensure we're working with absolute paths
MELANGE_WORKDIR='/home/build'
MELANGE_SCRIPT_DIR='/home/build/.melange-scripts'

# Set up build environment
export HOME="${HOME:-/home/build}"
export USER="${USER:-build}"
export SHELL="${SHELL:-/bin/sh}"

# Create and change to working directory
[ -d "$MELANGE_WORKDIR" ] || mkdir -p "$MELANGE_WORKDIR"
cd "$MELANGE_WORKDIR"

# Environment Variables
export TEST_VAR='test-value'

# Pipeline Script Content
echo "=== Running basic setup ==="
echo "Build environment ready"

exit 0
```

### Helper Scripts

#### run-all.sh

Executes all pipeline scripts in order. Can be run from anywhere:

```bash
# Run all scripts in sequence
/home/build/.melange-scripts/run-all.sh
```

Features:
- Loads environment automatically
- Skips helper scripts
- Handles return codes properly
- Provides progress feedback

#### environment.sh

Sets up the Melange build environment. Can be sourced manually:

```bash
# Set up environment manually
source /home/build/.melange-scripts/environment.sh
```

## Pipeline Control Options

Melange provides several options for controlling pipeline execution and script export:

### build-only

Steps marked with `build-only: true` run during the build but are **not** included in exported scripts. This is perfect for build-time validation that users shouldn't run manually.

```yaml
pipeline:
  - name: "build-validation"
    build-only: true
    runs: |
      echo "This runs during build but won't be exported"
      if [ ! -f required-file.txt ]; then
        echo "ERROR: Build validation failed"
        exit 1
      fi
```

### stop-after

Steps marked with `stop-after: true` halt pipeline execution after completing successfully, but the build continues to the packaging phase.

```yaml
pipeline:
  - name: "debug-checkpoint"
    stop-after: true
    runs: |
      echo "Pipeline stops here for debugging"
      echo "Packaging will still occur"
```

### skip-remaining

Steps marked with `skip-remaining: true` skip all remaining pipeline steps after completing successfully.

```yaml
pipeline:
  - name: "early-exit"
    skip-remaining: true
    runs: |
      echo "Skipping all remaining steps"
      echo "Moving directly to packaging"
```

## Return Code Conventions

Exported scripts use specific return codes to control execution flow:

- **0**: Success, continue to next script
- **1**: Error, stop execution with failure
- **2**: Success, stop pipeline execution (equivalent to `stop-after`)
- **3**: Success, skip remaining steps (equivalent to `skip-remaining`)

### Example Usage in Exported Scripts

```bash
# Modify an exported script to stop after this point
echo "exit 2" >> /home/build/.melange-scripts/step-03-debug.sh

# Modify an exported script to skip remaining steps
echo "exit 3" >> /home/build/.melange-scripts/step-05-early-exit.sh
```

## Use Cases

### Debugging Build Failures

1. Run build with `--save-scripts`
2. Use `--interactive` flag to examine the environment
3. Run individual scripts to isolate the problem
4. Modify scripts to test fixes

```bash
melange build --save-scripts --interactive --debug package.yaml
# In the interactive session:
/home/build/.melange-scripts/failing-step.sh
```

### Understanding Complex Builds

Export scripts to see exactly what each pipeline step does:

```bash
melange build --save-scripts complex-package.yaml
# Review the generated scripts to understand the build process
```

### Manual Testing and Development

Use exported scripts to test changes without full rebuilds:

```bash
# Run just the compilation step
/home/build/.melange-scripts/step-03-compile.sh

# Test with modifications
# Edit the script, then run it again
```

### CI/CD Integration

Save scripts as build artifacts for later debugging:

```bash
melange build --save-scripts package.yaml
# Archive /home/build/.melange-scripts/ as CI artifact
```

## Best Practices

### For Package Authors

1. **Use descriptive step names** - they become script filenames
2. **Mark validation steps as build-only** - keep exported scripts clean
3. **Add comments explaining complex logic** - they appear in exported scripts
4. **Use stop-after for debugging checkpoints** - easy places to pause during development

```yaml
pipeline:
  - name: "fetch-source"
    runs: |
      # Download and verify source code
      wget https://example.com/source.tar.gz
      
  - name: "validate-source"
    build-only: true
    runs: |
      # This validation won't clutter exported scripts
      sha256sum -c source.sha256
      
  - name: "debug-checkpoint"
    stop-after: true
    runs: |
      # Good place to examine source before building
      ls -la source/
```

### For Debugging

1. **Start with run-all.sh** - see the complete flow
2. **Use individual scripts** - isolate specific problems  
3. **Modify scripts temporarily** - test fixes quickly
4. **Check return codes** - understand flow control

### For CI/CD

1. **Archive script directories** - preserve debugging information
2. **Use build-only for CI-specific validation** - keep user scripts clean
3. **Consider stop-after for staged builds** - pause at specific points

## Integration with Interactive Debugging

Script export works seamlessly with Melange's interactive debugging:

```bash
# Build with both features
melange build --save-scripts --interactive package.yaml

# If a step fails, you're dropped into an interactive session where you can:
ls /home/build/.melange-scripts/
./step-that-failed.sh
# Edit and rerun scripts as needed
```

## Examples

### Simple Package

```yaml
package:
  name: hello-world
  version: 1.0.0

pipeline:
  - name: "setup"
    runs: echo "Setting up build"
    
  - name: "validate"
    build-only: true
    runs: |
      echo "Build-time validation"
      # This won't appear in exported scripts
      
  - name: "compile"
    runs: |
      echo "Compiling application"
      gcc -o hello hello.c
```

Generated scripts:
- `setup.sh` - Sets up build
- `compile.sh` - Compiles application  
- `run-all.sh` - Runs both setup and compile
- `environment.sh` - Environment setup

Note: The `validate` step is not exported because it's marked `build-only: true`.

### Complex Pipeline with Controls

```yaml
pipeline:
  - name: "fetch"
    runs: wget https://example.com/source.tar.gz
    
  - name: "debug-point"
    stop-after: true
    runs: |
      echo "Examine source here"
      tar -tf source.tar.gz
      
  # This and following steps only run if stop-after is disabled
  - name: "compile"
    runs: make all
    
  - name: "test"
    runs: make test
```

This allows you to:
1. Build normally: all steps run
2. Debug mode: stops after `debug-point`
3. In exported scripts: modify `debug-point.sh` to continue past the debug point

## Troubleshooting

### Scripts Not Generated

- Ensure `--save-scripts` flag is used
- Check that steps have `runs:` content (empty steps aren't exported)
- Verify steps aren't marked `build-only: true`

### Scripts Fail When Run Manually

- Check that environment is set up: `source environment.sh`
- Ensure you're in the correct working directory
- Verify required files exist from previous steps

### Permission Issues

- Scripts are created with executable permissions (`+x`)
- If permissions are lost, restore with: `chmod +x /home/build/.melange-scripts/*.sh`

## Limitations

- Scripts are saved in the build environment (VM/container)
- Build-only steps are intentionally excluded from export
- Scripts capture the state at export time (no dynamic template resolution)
- Complex pipeline dependencies may require running scripts in specific order

## Future Enhancements

Planned improvements include:
- Copying scripts to host filesystem
- Dependency graph generation
- Variable substitution documentation in script headers
- Integration with external debugging tools