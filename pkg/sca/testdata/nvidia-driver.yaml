package:
  name: nvidia-driver
  version: "590.48.01"
  epoch: 0
  description: NVIDIA driver userspace
  copyright:
    - license: LicenceRef-NVIDIA-DRIVER
      license-path: NVIDIA-LICENSE

environment:
  contents:
    repositories:
      - https://packages.wolfi.dev/os
    keyring:
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    packages:
      - busybox
      - jq

pipeline:
  - if: ${{build.arch}} == 'aarch64'
    uses: fetch
    with:
      uri: https://us.download.nvidia.com/tesla/${{package.version}}/NVIDIA-Linux-${{build.arch}}-${{package.version}}.run
      expected-sha256: 14ecfb7faa56d4d18cd9fef891b3fa2db3628f12a3e59b59d3c6e6d1a0befd80
      timeout: 30
      extract: false

  - if: ${{build.arch}} == 'x86_64'
    uses: fetch
    with:
      uri: https://us.download.nvidia.com/tesla/${{package.version}}/NVIDIA-Linux-${{build.arch}}-${{package.version}}.run
      expected-sha256: b9e2f80693781431cc87f4cd29109e133dcecb50a50d6b68d4b3bf2d696bd689
      timeout: 30
      extract: false

  - runs: |
      chmod +x ./NVIDIA-Linux-${{build.arch}}-${{package.version}}.run
      ./NVIDIA-Linux-${{build.arch}}-${{package.version}}.run --extract-only
      cp NVIDIA-Linux-${{build.arch}}-${{package.version}}/LICENSE NVIDIA-LICENSE

  - working-directory: NVIDIA-Linux-${{build.arch}}-${{package.version}}
    runs: |
      mkdir -p ${{targets.contextdir}}/usr/lib
      for i in libnvidia-ml.so libnvidia-allocator.so libnvidia-cfg.so; do
          install -Dm0755 -t ${{targets.contextdir}}/usr/lib "$i.${{package.version}}"
          ln -s "$i.${{package.version}}" ${{targets.contextdir}}/usr/lib/"$i.1"
      done

